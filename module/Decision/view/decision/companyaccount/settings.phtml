<?php

?>

<section class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-6">

                <?php
                //TODO make it such that when the experation date is in the past the correct message is
                // displayed also when starting date has yet to pass

                $now = new DateTime();
                $diff = $now->diff($companyPackageInfo[0]->getExpires());

                //If vacancy package will expire within one month display notification
                if ($diff->m === 0 && $diff->d > 0): ?>
                <div class="panel panel-default">
                    <div class="panel-body">
                        <strong><?= $this->translate("Vacancy package will expire within one month!")?></strong>
                    </div>
                </div>
                <?php endif; ?>

                <?php if ($diff->d <= 0): ?>
                <div class="panel panel-default">
                    <div class="panel-body">
                        <strong><?= $this->translate("Vacancy package has expired, please contact an administrator.")?></strong>
                    </div>
                </div>
                <?php endif; ?>

                <h1><?= $companyInfo[0]->getName() ?></h1>
                <h2><?= "Account status" ?></h2>
                <table class="table table-bordered">
                    <tr>
                        <th><?= $this->translate('Highlight credits') ?></th>
                        <td><?= $companyInfo[0]->getHighlightCredits() ?></td>
                    </tr>

                    <tr>
                        <th><?= $this->translate('Banner credits') ?></th>
                        <td><?= $companyInfo[0]->getBannerCredits()  ?></td>
                    </tr>

                    <tr>
                        <th><?= $this->translate('Contract number vacancy package') ?></th>
                        <td><?= "empty"  ?></td>
                    </tr>
                    <tr>
                        <th><?= $this->translate('Email subscription') ?></th>
                        <td><?= "empty"  ?></td>
                        <td><input type="checkbox" id="scales" name="scales" checked></td>
                    </tr>
                    <tr>
                        <th><?= $this->translate('Start date of membership') ?></th>
                        <td><?= $companyPackageInfo[0]->getStart()->format('l j F Y')?></td>
                    </tr>
                    <tr>
                        <th><?= $this->translate('End date of membership') ?></th>
                        <td><?= $companyPackageInfo[0]->getExpires()->format('l j F Y')?></td>
                    </tr>
                    <tr>
                        <th><?= $this->translate('Account status') ?></th>
                        <td>
                            <?php if ($diff->d <= 0):?>
                                inactive
                            <?php endif; ?>

                            <?php if ($diff->d > 0):?>
                                active
                            <?php endif; ?>
                        </td>
                    </tr>
                </table>

                <h2>Personal information (double click to edit)</h2>

                    <table class="table table-bordered">
                        <tr>
                            <th><?= $this->translate('Email') ?></th>
                            <td id="edit" name="email"><?= $companyInfo[0]->getEmail()?></td>
                        </tr>
                        </tr>
                        <tr>
                            <th><?= $this->translate('Country') ?></th>
                            <td name="country"><?= "empty"  ?></td>
                        </tr>
                        <tr>
                            <th><?= $this->translate('Street and number') ?></th>
                            <td id="edit" name="address"><?= $companyInfo[0]->getAddress()  ?></td>
                        </tr>
                        <tr>
                            <th><?= $this->translate('City and postal code') ?></th>
                            <td name="postalcode"><?= "empty" ?></td>
                        </tr>
                        <tr>
                            <th><?= $this->translate('Phone number') ?></th>
                            <td id="edit" name="phone"><?= $companyInfo[0]->getPhone()  ?></td>
                        </tr>
                    </table>


                <form id = "finalsubmit" name = "finalsubmit" method="post" action="/companyAccount/settings">
                    <input type="text" id="finaltext" name="finaltext" value="">
                    <input type="submit" value="Safe changes">
                </form>

                <script>
                    //dictionary storing all changed company settings
                    var dict = {email: "", address: "", phone: 0};

                    //the form that will submit the changes
                    var finalsubmit = document.getElementById("finalsubmit");

                    //the text field containing the changes
                    var finaltext = document.getElementById("finaltext");

                    //Set both the form and text field to be not vissible
                    finalsubmit.style.display = "none";
                    finaltext.style.display = "none";

                    //Select setting that is double clicked and has the tag "edit"
                    document.querySelectorAll("#edit").forEach(function(node){
                        node.ondblclick = function(){
                            //Make the form submit button visible
                            finalsubmit.style.display = "block";

                            //Setup the input text field
                            var val=this.innerHTML;
                            var input=document.createElement("input");
                            input.value=val;

                            //Set changed setting equal to the newly inputted value
                            //and update the form text field to store the changed values
                            input.onblur=function(){
                                var val=this.value;
                                this.parentNode.innerHTML=val;
                                dict[node.getAttribute("name")] = val;
                                console.log(dict);

                                var parsed = JSON.stringify(dict);
                                finaltext.value = parsed;
                            }

                            this.innerHTML="";
                            this.appendChild(input);
                            input.focus();
                        }
                    });
                </script>

                <?php
                    //If the form has been submitted, submit the changes to the database
                    if($_SERVER["REQUEST_METHOD"] === "POST") {
                        //Dictionary containing the new settings values
                        $changes = json_decode($_POST['finaltext']);

                        //array containing only the changed setting's names
                        $keys = [];
                        //array contaiing only the changed setting's values
                        $values = [];

                        $i = 0;
                        foreach($changes as $key=>$value) {
                            //only add setting to the aforementioned array
                            // when its value has been changed
                            if($value != 0 || $value != ""){
                                $keys[$i] = $key;
                                $values[$i] = $value;
                                $i++;
                            }
                        }

                        //TODO sanitize data

                        //send update request to the database
                        $settingsService->updateCompanyData($keys, $values, $companyInfo[0]->getName());
                    }
                ?>
            </div>
        </div>
    </div>
</section>


