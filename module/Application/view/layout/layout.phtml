<?php

declare(strict_types=1);

use Application\View\HelperTrait;
use Laminas\View\Renderer\PhpRenderer;

/** @var PhpRenderer|HelperTrait $this */
?>
<?= $this->doctype(); ?>

<html lang="<?= $this->plugin('translate')->getTranslator()->getLocale() ?>">
<head>
    <meta charset="utf-8">
    <?= $this->headTitle($this->translate('Study Association GEWIS'))->setSeparator(' - ')->setAutoEscape(false) ?>

    <?= $this->headMeta()
        ->appendName('viewport', 'width=device-width, initial-scale=1.0')
    ?>

    <!-- Display alternate language links-->
    <?php
     if (isset($_SERVER['REQUEST_URI'])) {
         $strippedPath = ltrim(
             substr(
                 $_SERVER['REQUEST_URI'],
                 strlen($this->basePath()),
             ),
             '/',
         );

         // Remove the language from the URL, keep the leading `/`.
         if (str_starts_with($strippedPath, 'en/')) {
             $strippedPath = substr($strippedPath, strlen('en'));
         } elseif (str_starts_with($strippedPath, 'nl/')) {
             $strippedPath = substr($strippedPath, strlen('nl'));
         } elseif (
             'en' === $strippedPath
             || 'nl' === $strippedPath
         ) {
             $strippedPath = '';
         }

         // If we are at the "root", remove the slash.
         if ('/' === $strippedPath) {
             $strippedPath = '';
         }

         $this->headLink([
             'rel' => 'alternate', 'type' => 'text/html', 'hreflang' => 'en',
             'href' => $this->serverUrl($this->basePath('en' . $strippedPath)),
         ]);
         $this->headLink([
             'rel' => 'alternate', 'type' => 'text/html', 'hreflang' => 'nl',
             'href' => $this->serverUrl($this->basePath('nl' . $strippedPath)),
         ]);
     }
    ?>

    <!-- Preload fonts-->
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/raleway/raleway-v22-latin-500.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/raleway/raleway-v22-latin-600.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/raleway/raleway-v22-latin-regular.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/lato/lato-v22-latin-700.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/lato/lato-v22-latin-regular.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/lato/lato-v22-latin-italic.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/fontawesome/fa-solid-900.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/woff2',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/fontawesome/fa-brands-400.woff2',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'font',
        'rel' => 'preload',
        'type' => 'font/ttf',
        'crossorigin' => 'anonymous',
        'href' => '/fonts/gewisicons/gewisicons.ttf?37l19n',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'image',
        'rel' => 'preload',
        'type' => 'image/svg+xml',
        'href' => '/img/nl.svg',
    ]); ?>
    <?php
    $this->headLink([
        'as' => 'image',
        'rel' => 'preload',
        'type' => 'image/svg+xml',
        'href' => '/img/en.svg',
    ]); ?>

    <!-- Le styles -->
    <!-- All headLinks are outputted here once. -->
    <?= $this->headLink(
        ['rel' => 'shortcut icon', 'type' => 'image/x-icon', 'href' => $this->basePath() . '/img/favicon.ico']
    )
        ->prependStylesheet($this->basePath() . '/css/gewis-theme.css') ?>

    <!-- Scripts -->
    <?= $this->headScript()
        ->prependFile(
            $this->basePath() . '/js/jquery.min.js',
            'text/javascript',
            ['nonce' => NONCE_REPLACEMENT_STRING],
        )
        ->prependFile(
            $this->basePath() . '/js/url-helper.js',
            'text/javascript',
            ['nonce' => NONCE_REPLACEMENT_STRING],
        ); ?>

    <?php
    $matomoDomain = getenv('MATOMO_DOMAIN'); ?>
    <script type="text/javascript" nonce="<?= NONCE_REPLACEMENT_STRING ?>">
        let matomoDomain = '<?= $matomoDomain ?>';
        var _paq = window._paq = window._paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        _paq.push(['enableHeartBeatTimer']);
        _paq.push(['setTrackerUrl', '<?= $matomoDomain ?>/matomo.php']);
        _paq.push(['setSiteId', '1']);
    </script>
    <script src="<?= $matomoDomain . '/matomo.js' ?>" nonce="<?= NONCE_REPLACEMENT_STRING ?>" async defer></script>
</head>
<body>
<?= $this->partial('partial/main-nav.phtml') ?>

<?php
$viewModel = current($this->viewModel()->getCurrent()->getChildren());

if (str_contains($viewModel->getTemplate(), 'admin')): ?>
    <?= $this->partial('partial/admin.phtml', ['content' => $this->content]) ?>
<?php
elseif (str_contains($viewModel->getTemplate(), 'company-account')): ?>
    <?= $this->partial('partial/company.phtml', ['content' => $this->content]) ?>
<?php
else: ?>
    <div class="content-container">
        <?= $this->content ?>
    </div>
    <?= $this->partial('partial/footer.phtml') ?>
<?php
endif; ?>

<?= $this->partial('partial/privacy-widget.phtml') ?>

<!-- Scripts -->
<?= $this->inlineScript()
    ->prependFile(
        $this->basePath() . '/js/bootstrap.min.js',
        'text/javascript',
        ['nonce' => NONCE_REPLACEMENT_STRING],
    )
    ->prependFile(
        $this->basePath() . '/js/privacy-widget.js',
        'text/javascript',
        ['nonce' => NONCE_REPLACEMENT_STRING],
    )
    ->prependFile(
        $this->basePath() . '/js/navbar.js',
        'text/javascript',
        ['nonce' => NONCE_REPLACEMENT_STRING],
    ); ?>
<script type="text/javascript" nonce="<?= NONCE_REPLACEMENT_STRING ?>">
    <?php foreach($this->scriptUrl()->getUrls() as $name => $url): ?>
    URLHelper.addUrl('<?= $name ?>', '<?= urldecode($url) ?>');
    <?php endforeach; ?>
</script>
</body>
</html>
